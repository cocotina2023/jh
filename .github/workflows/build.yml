      - name: Obfuscate op.js
        run: |
          # 提取 header（前两行保留原样）
          head -n 2 op.js > header.js

          # 其余部分
          tail -n +3 op.js > body.js

          # 混淆 body
          javascript-obfuscator body.js \
            --output body.tmp.js \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 0.75 \
            --dead-code-injection true \
            --dead-code-injection-threshold 0.4 \
            --string-array true \
            --string-array-encoding base64 \
            --string-array-threshold 0.75 \
            --rename-globals true \
            --identifier-names-generator mangled \
            --numbers-to-expressions true \
            --split-strings true \
            --split-strings-chunk-length 10 \
            --transform-object-keys true \
            --self-defending false \
            --debug-protection false \
            --disable-console-output true

          # 手动加 IIFE 包裹
          echo "(function(){" > body.obf.js
          cat body.tmp.js >> body.obf.js
          echo "})();" >> body.obf.js

          # 移除所有类似 // <!-- ... --> 的注释行
          sed -i '/^\/\/ *<!--.*-->.*$/d' body.obf.js

          # 合并 header + 混淆 body → 覆盖根目录 opp.js
          cat header.js body.obf.js > opp.js

          echo "✅ Generated opp.js at project root (clean, no injected comments)"
