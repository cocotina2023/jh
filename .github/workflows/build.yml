name: Obfuscate op.js (produce opp.js at repo root & preview)

on:
  workflow_dispatch:

jobs:
  build-and-obfuscate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install JavaScript Obfuscator
        run: npm install javascript-obfuscator

      - name: Build opp.js (robust header extraction, obfuscate body)
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const JavaScriptObfuscator = require('javascript-obfuscator');

          const srcPath = path.resolve('op.js');
          if (!fs.existsSync(srcPath)) {
            console.error('❌ op.js not found in repo root');
            process.exit(1);
          }

          const src = fs.readFileSync(srcPath, 'utf8');

          // 匹配 header: let userID = "..." ; const proxyIPs = [ ... ];
          const headerRegex = /let\s+userID\s*=\s*"([^"]+)";\s*[\r\n]+const\s+proxyIPs\s*=\s*\[[^\]]*\]\s*;?/i;
          const headerMatch = src.match(headerRegex);
          if (!headerMatch) {
            console.error('❌ header not found. Ensure op.js contains:');
            console.error('   let userID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx";');
            console.error('   const proxyIPs = [""];');
            process.exit(1);
          }

          const headerText = headerMatch[0].trim();
          const uuidCandidate = headerMatch[1].trim();

          // Optional UUID check (warn only)
          const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          if (!uuidRegex.test(uuidCandidate)) {
            console.warn('⚠️ header UUID format looks unusual:', uuidCandidate);
          } else {
            console.log('✅ Header UUID looks valid:', uuidCandidate);
          }

          // body is source minus first matched header occurrence
          const body = src.replace(headerMatch[0], '');

          // obfuscate body
          const obf = JavaScriptObfuscator.obfuscate(body, {
            compact: true,
            controlFlowFlattening: true,
            controlFlowFlatteningThreshold: 0.75,
            deadCodeInjection: true,
            deadCodeInjectionThreshold: 0.4,
            stringArray: true,
            stringArrayEncoding: ['base64'],
            stringArrayThreshold: 0.75,
            renameGlobals: true,
            identifierNamesGenerator: 'mangled',
            numbersToExpressions: true,
            splitStrings: true,
            splitStringsChunkLength: 10,
            transformObjectKeys: true,
            selfDefending: false,
            debugProtection: false,
            disableConsoleOutput: true
          }).getObfuscatedCode();

          // assemble final with header + IIFE
          let final = headerText + '\n\n(function(){\n' + obf + '\n})();\n';

          // remove any injected <!--...--> comment lines
          final = final.replace(/^\/\/ *<!--.*-->.*$/gm, '');
          final = final.replace(/^\s*<!--.*-->.*$/gm, '');

          const outPath = path.resolve('opp.js');
          fs.writeFileSync(outPath, final, 'utf8');

          console.log('✅ opp.js generated at repo root');
          console.log('----- opp.js preview (first 20 lines) -----');
          console.log(final.split(/\\r?\\n/).slice(0,20).join('\\n'));
          console.log('-------------------------------------------');
          NODE

      - name: Ensure op.js ignored and commit opp.js
        run: |
          # add op.js to .gitignore to avoid leaking source
          touch .gitignore
          if ! grep -qx 'op.js' .gitignore; then
            echo 'op.js' >> .gitignore
            echo 'Added op.js to .gitignore'
          fi

          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .gitignore opp.js
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m 'build: generate obfuscated opp.js'
            git push
          fi
