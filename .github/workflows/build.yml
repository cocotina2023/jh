name: Obfuscate op.js

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Checkout
      - uses: actions/checkout@v4

      # 2. Setup Node
      - uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. Install obfuscator
      - run: npm install javascript-obfuscator

      # 4. Build opp.js
      - name: Build opp.js
        run: |
          node <<'EOF'
          const fs = require("fs");
          const JavaScriptObfuscator = require("javascript-obfuscator");

          const source = fs.readFileSync("op.js", "utf8").split("\n");

          // 保留前两行作为 header
          const header = source.slice(0, 2).join("\n");
          const body = source.slice(2).join("\n");

          // 混淆 body
          const obfuscated = JavaScriptObfuscator.obfuscate(body, {
            compact: true,
            controlFlowFlattening: true,
            controlFlowFlatteningThreshold: 0.75,
            deadCodeInjection: true,
            deadCodeInjectionThreshold: 0.4,
            stringArray: true,
            stringArrayEncoding: ["base64"],
            stringArrayThreshold: 0.75,
            renameGlobals: true,
            identifierNamesGenerator: "mangled",
            numbersToExpressions: true,
            splitStrings: true,
            splitStringsChunkLength: 10,
            transformObjectKeys: true,
            selfDefending: false,
            debugProtection: false,
            disableConsoleOutput: true,
          }).getObfuscatedCode();

          // 合并 header + IIFE
          let finalCode = `${header}\n\n(function(){\n${obfuscated}\n})();\n`;

          // 清理 GAMFC 注释
          finalCode = finalCode.replace(/^\/\/ *<!--.*-->.*$/gm, "");

          fs.writeFileSync("opp.js", finalCode, "utf8");
          console.log("✅ opp.js generated");
          EOF

      # 5. 检查 header 是否存在
      - name: Validate header
        run: |
          if ! grep -q "let userID" opp.js; then
            echo "❌ opp.js missing header (let userID ...)"
            exit 1
          fi
          echo "✅ opp.js header OK"

      # 6. Commit opp.js
      - name: Commit opp.js
        run: |
          echo "op.js" >> .gitignore
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .gitignore opp.js
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m 'build: generate opp.js'
            git push
          fi

      # 7. Preview 前 5 行
      - name: Preview opp.js
        run: head -n 5 opp.js
